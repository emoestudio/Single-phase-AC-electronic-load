# 电力电子程序猿设计流程

### 配置

1. RCC 
   1. 160MHz APB2 80MHz APB1
   2. 8 /8 320 /2 
2. Timer
   1. TIM2 20kHz控制频率 10-1 400-1 注意其是APB1
   2. TIM1 PWM 单极倍频调制 10-1 400-1 注意其是APB2，如果使用它的update中断会使中断频率为40kHz
   3. 注意死区 10
   4. Center Aligned Mode 1
3. ADC
   1.  Enable 三个mode方便DMA切换，Rank依次排列
   2. 使能DMA
4. DAC
   1. 点Output就完事了
5. GPIO(按键和显示)
   1. Input 和Output 就okkk，按键是按下接地，所以Input的要pull up
6. USART(屏幕)
   1. 使能异步串口即可

### 代码

功能板块：

1. 时钟计数

   功能：进行计数，每次到达1s时清零

   用来做延时处理，进行按键检测（在时钟中断）和屏幕刷新（在while内）

   参数 static int time_Tim2;

2. ADC和数据处理

   采样ADC，计算和滤波得到对应采样真实值，进行数组记录，park变换，显示参数计算等等

3. 锁相环和锁相环成功检测

   锁相环得到ws，加滤波，进行角度的累加和处理，每次2pi清零

   锁相环检测，如果失败了要能断开

4. 自恢复起动和保护关断

   发现锁相失败/过压过流要关断

   发现锁相成功/正常工况/均值已经取完要打开

5. 设定值设定

   设计系统运行逻辑

6. 环与控制（包括前馈）

   电压外环电流内环

7. PWM输出

   通过Dd进行反向变换进行输出

8. 按键识别

   

